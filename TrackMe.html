<!DOCTYPE html>
<html>
  <head>
    <title>My Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="cssFiles/mainpages.css">
    <title>Hackateam</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat|Ubuntu" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
      
    <style>
        body{
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #1a1a1a;
            text-align: left;
            height: 100%;
            background-color: #fff;
        }
          /* Always set the map height explicitly to define the size of the div
           * element that contains the map. */
          #map {
            height: 90%;
          }
          /* Optional: Makes the sample page fill the window. */
          html{
            height: 100%;
            line-height: 1.15;
            font-family: sans-serif;
          }
    </style>
  </head>
    <body>
        <section>
            <div>
                <div class='navbar'>
                    <div class='logo'>
                    HACKAMAP |
                    </div>           
                    <div class='navbar-item'>
                        <nav>
                            <ul>
                                <li><a href="MainPage.html">Home</a></li>
                                <li><a href="ReportPage.html">Report Status</a></li>
                                <li><a href="TrackMe.html">Track Me</a></li>
                                <li><a href='map3.html'>Location Check</a></li>
                                <li><a href="#" onclick="SignOut()">Sign Out</a></li> 
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <div id="map" class="map"></div>

        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
             https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-firestore.js"></script>

        <script>
          // Your web app's Firebase configuration
          var firebaseConfig = {
            apiKey: "AIzaSyB694vlhD5k2WJ0Nequs30AAr2R9n8BRB8",
            authDomain: "hackamap-7c8ee.firebaseapp.com",
            databaseURL: "https://hackamap-7c8ee.firebaseio.com",
            projectId: "hackamap-7c8ee",
            storageBucket: "hackamap-7c8ee.appspot.com",
            messagingSenderId: "483911421310",
            appId: "1:483911421310:web:df3ea271a8a0f7ad6ab72f",
            measurementId: "G-GBYD2X2JH9"
          };
          // Initialize Firebase
          firebase.initializeApp(firebaseConfig);
          firebase.analytics();
            
            const fAuth = firebase.auth();
            const fStore = firebase.firestore();
            var watchID;
            var geoLoc;
            var userID;
            
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log("Here is userID " + user.uid);
                    userID = user.uid;
                } else {
                    console.log("Cannot get userid");
                    alert("Please log in again");
                    window.location.assign("SignIn.html")
                }
            });
            
            function initMap(){
                var map;
                var marker;
                
                var map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: 22, lng: 105},
                    zoom: 15
                });
                
                var marker = new google.maps.Marker({
                    map,
                    position: {lat: 22, lng: 105},
                    title: "Your Location"
                });
                
                if(navigator.geolocation){
                    var options = {timeout: 3000, enableHighAccuracy: true};
                    geoLoc = navigator.geolocation;
                    watchID = geoLoc.watchPosition(function showLocation(position){
                        var user_list = [];
                        var num_infected = 0;
                        var latitude = position.coords.latitude;
                        var longtitude = position.coords.longitude;
                        console.log("Here is your location: ", latitude, longtitude);
                        marker.setPosition({lat: latitude, lng: longtitude});
                        map.setCenter({lat: latitude, lng: longtitude});
                        
                        fAuth.onAuthStateChanged(function(user){
                            if (user){
                                userID = user.uid;
                                console.log(userID);
                                
                                fStore.collection("User").doc(userID).update({
                                    latitude: latitude,
                                    longitude: longtitude
                                })
                                .then(function(){
                                    console.log("Update Firebase successfully");
                                })
                                .catch(function(error){
                                    alert(error)
                                });
                                
                                fStore.collection("User").get().then(function(querySnapshot){
                                    querySnapshot.forEach(function(doc){
                                        if (doc.id != userID){
                                            var user_data = doc.data();
                                            var date = new Date().toString();
                                            var fname_near = user_data.first_name;
                                            var lname_near = user_data.last_name;
                                            var userID_near = user_data.userID;
                                            var infected_near = user_data.infected;
                                            var latitude_near = user_data.latitude;
                                            var longitude_near = user_data.longitude;
                                            console.log(userID_near);
                                            console.log(measure(latitude, longtitude, latitude_near, longitude_near));
                                            if (measure(latitude, longtitude, latitude_near, longitude_near) < 1000){
                                                console.log("You reach here")
                                                fStore.collection("User").doc(userID).collection("contact").doc(userID_near).set({
                                                    first_name: fname_near,
                                                    last_name: lname_near,
                                                    userID: userID_near,
                                                    infected: infected_near,
                                                    latitude: latitude_near,
                                                    longitude: longitude_near
                                                });
                                                
                                                if (infected_near){
                                                    num_infected++;
                                                    alert("You have come to contact with Corona-19 patients. Please go to the nearest medical center!");
                                                }
                                            }
                                        }
                                    })
                                });
                            }
                            else{
                                console.log("Failed to load user.")
                            }
                        })
                    }, errorHandler, options);
                }
            }
            
            function errorHandler(err){
                console.log("Error");
            }
            
            function measure(lat1, lon1, lat2, lon2){  
                var R = 3958.8; // Radius of the Earth in miles
                var rlat1 = lat1 * (Math.PI/180); // Convert degrees to radians
                var rlat2 = lat2 * (Math.PI/180); // Convert degrees to radians
                var difflat = rlat2-rlat1; // Radian difference (latitudes)
                var difflon = (lon2 - lon1) * (Math.PI/180); // Radian difference (longitudes)

                var d = 2 * R * Math.asin(Math.sqrt(Math.sin(difflat/2)*Math.sin(difflat/2)+Math.cos(rlat1)*Math.cos(rlat2)*Math.sin(difflon/2)*Math.sin(difflon/2)));
                var e = d * 1609; //convert miles to meter
                return e;
            }
            
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlfYmAu4aToK-LTSZlBCV2MnQCYohXn4Q&callback=initMap"
    async defer></script>
    </body>
</html>